<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>WebXR true-AR MP4 demo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{margin:0;overflow:hidden;font:16px/1.4 system-ui, sans-serif}
    #fallback{padding:2em;text-align:center}
    a{color:#06f}
  </style>
</head>
<body>

<div id="fallback" hidden>
  <p><strong>This experience needs an AR-capable browser.</strong></p>
  <p>Try Chrome 124 + on Android, or a PC with an XR headset (Quest 3/Pro in Link, Vive XR Elite, Varjo, etc.).</p>
  <p><a href="https://immersiveweb.dev/" target="_blank">More about WebXR »</a></p>
</div>

<script type="module">
import * as THREE   from 'https://unpkg.com/three@0.155.0/build/three.module.js';
import { ARButton } from 'https://unpkg.com/three@0.155.0/examples/jsm/webxr/ARButton.js';

/* ── 0 · Test AR support ────────────────────────────── */
const supported = await navigator.xr?.isSessionSupported?.('immersive-ar');
if (!supported) {
  document.getElementById('fallback').hidden = false;
  throw new Error('immersive-ar not supported');
}

/* ── 1 · Renderer / scene / camera ───────────────────── */
const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
renderer.xr.enabled = true;
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

const scene  = new THREE.Scene();
const camera = new THREE.PerspectiveCamera();

/* ── 2 · WebXR entry button ─────────────────────────── */
document.body.appendChild(
  ARButton.createButton(renderer, { requiredFeatures:['hit-test','anchors'] })
);

/* ── 3 · Video element & texture (starts on first tap) ─ */
const video = Object.assign(document.createElement('video'), {
  src:'/video/123.mp4',
  loop:true,
  muted:true,
  playsInline:true
});
let videoTexture; // created after first play()

/* ── 4 · Reticle (cursor) ───────────────────────────── */
const reticle = new THREE.Mesh(
  new THREE.RingGeometry(0.05,0.06,32).rotateX(-Math.PI/2),
  new THREE.MeshBasicMaterial({ color:0xffffff })
);
reticle.matrixAutoUpdate = false;
reticle.visible = false;
scene.add(reticle);

/* ── 5 · Hit-test & anchor plumbing ─────────────────── */
let hitTestSource = null, viewerSpace = null;

renderer.xr.addEventListener('sessionstart', async () => {
  const session = renderer.xr.getSession();
  viewerSpace   = await session.requestReferenceSpace('viewer');
  hitTestSource = await session.requestHitTestSource({ space:viewerSpace });

  session.addEventListener('end', () => { hitTestSource = viewerSpace = null; });
});

/* ── 6 · Controller: tap to place video ─────────────── */
const controller = renderer.xr.getController(0);
controller.addEventListener('select', place);
scene.add(controller);

async function place() {
  if (!reticle.visible) return;

  /* First tap: start playback & make the texture */
  if (video.paused) {
    await video.play();
    videoTexture = new THREE.VideoTexture(video);
    videoTexture.encoding = THREE.sRGBEncoding;
    videoTexture.generateMipmaps = false;
  }

  const plane = new THREE.Mesh(
    new THREE.PlaneGeometry(1,0.6),              // 1 m × 0.6 m
    new THREE.MeshBasicMaterial({ map:videoTexture, side:THREE.DoubleSide })
  );
  plane.position.setFromMatrixPosition(reticle.matrix);
  plane.quaternion.setFromRotationMatrix(reticle.matrix);
  scene.add(plane);

  /* Anchor makes the pose stick as SLAM refines */
  const anchor = await renderer.xr.getSession()
    .createAnchor(reticle.matrix, renderer.xr.getReferenceSpace());
  anchor.context = plane;      // (optional bookkeeping)
}

/* ── 7 · Main loop ──────────────────────────────────── */
renderer.setAnimationLoop((t, frame) => {
  if (frame && hitTestSource) {
    const hits = frame.getHitTestResults(hitTestSource);
    if (hits.length) {
      const pose = hits[0].getPose(renderer.xr.getReferenceSpace());
      reticle.matrix.fromArray(pose.transform.matrix);
      reticle.visible = true;
    } else {
      reticle.visible = false;
    }
  }
  renderer.render(scene, camera);
});
</script>
</body>
</html>
