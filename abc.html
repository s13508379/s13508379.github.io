<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WebXR true-AR MP4 demo</title>
  <style>body{margin:0;overflow:hidden}</style>
</head>
<body>
<script type="module">
import * as THREE   from 'https://unpkg.com/three@0.155.0/build/three.module.js';
import { ARButton } from 'https://unpkg.com/three@0.155.0/examples/jsm/webxr/ARButton.js';

/* ───────────────────────────── renderer & scene ─────────────────────────── */
const renderer = new THREE.WebGLRenderer({ antialias:true, alpha:true });
renderer.xr.enabled = true;
renderer.setSize(innerWidth, innerHeight);
document.body.appendChild(renderer.domElement);

const scene   = new THREE.Scene();
const camera  = new THREE.PerspectiveCamera();

/* ─────────────────────────────  XR entry button ─────────────────────────── */
document.body.appendChild(
  ARButton.createButton(renderer, { requiredFeatures:['hit-test','anchors'] })
); // hit-test → plane detection · anchors → world-locked poses  :contentReference[oaicite:1]{index=1}

/* ─────────────────────────────  video texture  ──────────────────────────── */
const video = document.createElement('video');
Object.assign(video, { src:'/video/123.mp4', loop:true, muted:true, playsInline:true });

/* MP4 must start *inside* a gesture – we’ll call play() after user taps      */

/* ─────────────────────────────  reticle (cursor)  ───────────────────────── */
const reticle = new THREE.Mesh(
  new THREE.RingGeometry(0.05, 0.06, 32).rotateX(-Math.PI/2),
  new THREE.MeshBasicMaterial({ color:0xffffff })
);
reticle.matrixAutoUpdate = false;
reticle.visible = false;
scene.add(reticle);

/* ─────────────────────────────  hit-test setup  ─────────────────────────── */
let hitTestSource = null;
let viewerSpace   = null;

renderer.xr.addEventListener('sessionstart', async () => {
  const session = renderer.xr.getSession();
  viewerSpace   = await session.requestReferenceSpace('viewer');
  hitTestSource = await session.requestHitTestSource({ space: viewerSpace });

  session.addEventListener('end', () => { hitTestSource = viewerSpace = null; });
});

/* ─────────────────────────────  controller tap  ─────────────────────────── */
const controller = renderer.xr.getController(0);
controller.addEventListener('select', placeVideo);
scene.add(controller);

async function placeVideo() {
  if (!reticle.visible) return;

  /* first tap starts playback */
  if (video.paused) await video.play();

  const texture = new THREE.VideoTexture(video);
  texture.encoding = THREE.sRGBEncoding;
  texture.generateMipmaps = false;

  const plane = new THREE.Mesh(
    new THREE.PlaneGeometry(1, 0.6),          // 1 m × 0.6 m billboard
    new THREE.MeshBasicMaterial({ map:texture, side:THREE.DoubleSide })
  );
  plane.position.setFromMatrixPosition(reticle.matrix);
  plane.quaternion.setFromRotationMatrix(reticle.matrix);
  scene.add(plane);

  /* pin pose to world via Anchor */
  const anchor = await renderer.xr.getSession()
    .createAnchor(reticle.matrix, renderer.xr.getReferenceSpace());  // :contentReference[oaicite:2]{index=2}
  anchor.context = plane; // optional bookkeeping
}

/* ─────────────────────────────  main loop  ──────────────────────────────── */
renderer.setAnimationLoop((t, frame) => {
  if (frame && hitTestSource) {
    const results = frame.getHitTestResults(hitTestSource);          // :contentReference[oaicite:3]{index=3}
    if (results.length) {
      const pose = results[0].getPose(renderer.xr.getReferenceSpace());
      reticle.visible = true;
      reticle.matrix.fromArray(pose.transform.matrix);
    } else {
      reticle.visible = false;
    }
  }
  renderer.render(scene, camera);
});
</script>
</body>
</html>
