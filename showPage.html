<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Webcam + AR overlay manager</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <style>
        :root {
            --ov-w: 260px;
        }

        html,
        body {
            margin: 0;
            height: 100%;
            overflow: hidden;
            font-family: sans-serif
        }

        #stage {
            position: relative;
            width: 100%;
            height: 100%;
            background: #000
        }

        #cam {
            width: 100%;
            height: 100%;
            object-fit: cover
        }

        .overlay {
            position: absolute;
            width: var(--ov-w);
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            mix-blend-mode: screen;
            cursor: grab;
        }

        .overlay.locked {
            cursor: default;
            pointer-events: none
        }

        #controls {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, .6);
            color: #fff;
            padding: 8px 14px;
            border-radius: 12px;
            display: flex;
            gap: 12px;
            align-items: flex-start;
            font-size: 14px
        }

        #controls label {
            cursor: pointer
        }

        /* Ê∏ÖÂñÆ + ‰ΩçÁΩÆËº∏ÂÖ•Ê°Ü */
        #layerBox {
            display: flex;
            gap: 10px
        }

        #layers {
            max-height: 180px;
            overflow: auto
        }

        #layers li {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 2px 4px;
            border-radius: 4px;
            cursor: pointer;
        }

        #layers li.active {
            background: #4caf50
        }

        .layer-btn {
            background: #222;
            color: #fff;
            border: 1px solid #888;
            border-radius: 4px;
            padding: 0 4px;
            font-size: 12px;
            cursor: pointer
        }

        #posEditor {
            display: flex;
            gap: 6px;
            align-items: center
        }

        #posEditor input {
            width: 58px;
            background: #222;
            color: #fff;
            border: 1px solid #888;
            border-radius: 4px;
            padding: 2px;
            font-size: 13px
        }

        #applyPos {
            background: #4caf50;
            color: #fff;
            border: 1px solid #888;
            border-radius: 4px;
            padding: 3px 8px;
            cursor: pointer
        }
    </style>
</head>

<body>

    <div id="stage">
        <video id="cam" playsinline autoplay muted></video>
    </div>

    <div id="controls">
        <label>+ Add overlay
            <input type="file" id="pick" accept="video/*" hidden>
        </label>

        <div id="layerBox">
            <ul id="layers"></ul>

            <div id="posEditor" hidden>
                top <input id="tIn">
                left <input id="lIn">
                tx <input id="txIn">
                ty <input id="tyIn">
                <button id="applyPos">Apply</button>
            </div>
        </div>
    </div>

    <script>

        (async () => {
            try {
                cam.srcObject = await navigator.mediaDevices.getUserMedia({ video: true });
            } catch (e) { alert(e.message) }
        })();


        let current = null;
        let zSeq = 1;
        const stage = document.getElementById('stage');
        const list = document.getElementById('layers');
        const posUI = document.getElementById('posEditor');
        const [tIn, lIn, txIn, tyIn] = ['tIn', 'lIn', 'txIn', 'tyIn'].map(id => document.getElementById(id));

        function px2pct(px, total) { return (px / total * 100).toFixed(2) + '%' }
        function updateInputs(ov) {
            tIn.value = ov.style.top || '50%';
            lIn.value = ov.style.left || '50%';
            const m = /translate\(([^,]+),\s*([^)]+)\)/.exec(ov.style.transform) || ['', '-50%', '-50%'];
            txIn.value = m[1]; tyIn.value = m[2];
        }

        function addOverlay(src, name) {
            const v = document.createElement('video');
            Object.assign(v, {
                src, loop: true, muted: true, playsInline: true, autoplay: true,
                className: 'overlay', dataset: { locked: '0' }
            });
            v.style.zIndex = ++zSeq;
            stage.appendChild(v);

            let ox = 0, oy = 0;
            v.addEventListener('pointerdown', e => {
                if (v.classList.contains('locked')) return;
                ox = e.offsetX; oy = e.offsetY; v.style.cursor = 'grabbing';
                const mv = m => {
                    v.style.left = px2pct(m.pageX - ox, stage.clientWidth);
                    v.style.top = px2pct(m.pageY - oy, stage.clientHeight);
                };
                document.addEventListener('pointermove', mv);
                document.addEventListener('pointerup', () => {
                    document.removeEventListener('pointermove', mv);
                    v.style.cursor = 'grab'; updateInputs(v);
                }, { once: true });
            });

            v.onclick = e => { e.stopPropagation(); select(v, li) };

            const li = document.createElement('li'); select(v, li);
            li.innerHTML = `<span>${name}</span>
                <button class="layer-btn lock">üîì</button>
                <button class="layer-btn up">‚Üë</button>
                <button class="layer-btn down">‚Üì</button>`;
            list.appendChild(li);

            li.querySelector('.lock').onclick = e => {
                const btn = e.target;
                v.classList.toggle('locked');
                btn.textContent = v.classList.contains('locked') ? 'üîí' : 'üîì';
            };
            li.querySelector('.up').onclick = () => { v.style.zIndex = ++zSeq };
            li.querySelector('.down').onclick = () => { v.style.zIndex = --zSeq };

            li.firstChild.onclick = () => select(v, li);
        }

        function select(ov, li) {
            current = ov;
            list.querySelectorAll('li').forEach(x => x.classList.remove('active'));
            li.classList.add('active');
            posUI.hidden = false; updateInputs(ov);
            ov.style.zIndex = ++zSeq;
        }


        pick.onchange = e => {
            const f = e.target.files[0]; if (!f) return;
            addOverlay(URL.createObjectURL(f), f.name); e.target.value = '';
        };

        applyPos.onclick = () => {
            if (!current) return;
            current.style.top = tIn.value; current.style.left = lIn.value;
            current.style.transform = `translate(${txIn.value},${tyIn.value})`;
        };

        stage.addEventListener('click', () => { list.querySelectorAll('li').forEach(x => x.classList.remove('active')); posUI.hidden = true; current = null })
    </script>
</body>

</html>