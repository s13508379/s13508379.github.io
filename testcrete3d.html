<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR 多視頻合成器</title>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            overflow: hidden;
        }
        
        #scene-container {
            width: 100vw;
            height: 100vh;
            position: relative;
        }
        
        #controls {
            position: absolute;
            top: 20px;
            left: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px;
            border-radius: 10px;
            max-height: 80vh;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .video-control {
            margin-bottom: 20px;
            padding: 15px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        
        .video-control h3 {
            margin-top: 0;
            color: #4CAF50;
        }
        
        .control-group {
            margin: 10px 0;
        }
        
        .control-group label {
            display: inline-block;
            width: 80px;
            font-size: 12px;
        }
        
        .control-group input[type="range"] {
            width: 150px;
        }
        
        .control-group input[type="number"] {
            width: 60px;
            background: rgba(255, 255, 255, 0.2);
            border: 1px solid #555;
            color: white;
            padding: 2px 5px;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        #ar-button {
            position: absolute;
            bottom: 20px;
            right: 20px;
            background: #2196F3;
            font-size: 18px;
            padding: 15px 30px;
        }
        
        #ar-button:hover {
            background: #1976D2;
        }
        
        #file-input {
            margin: 10px 0;
        }
        
        #status {
            position: absolute;
            bottom: 20px;
            left: 20px;
            color: white;
            background: rgba(0, 0, 0, 0.7);
            padding: 10px;
            border-radius: 5px;
        }
        
        .remove-btn {
            background: #f44336;
            padding: 5px 10px;
            font-size: 12px;
        }
        
        .remove-btn:hover {
            background: #d32f2f;
        }
    </style>
</head>
<body>
    <div id="scene-container"></div>
    
    <div id="controls">
        <h2>AR 視頻控制面板</h2>
        
        <div>
            <input type="file" id="file-input" accept="video/*" multiple>
            <button onclick="loadVideos()">載入視頻</button>
        </div>
        
        <div>
            <button onclick="togglePlayAll()">全部播放/暫停</button>
            <button onclick="resetPositions()">重置位置</button>
        </div>
        
        <div id="video-controls"></div>
    </div>
    
    <button id="ar-button" onclick="toggleAR()">啟動 AR</button>
    
    <div id="status">準備就緒</div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // 全局變量
        let scene, camera, renderer;
        let videos = [];
        let videoPlanes = [];
        let isARActive = false;
        let xrSession = null;
        let xrRefSpace = null;
        let gl = null;
        
        // 初始化 Three.js 場景
        function initScene() {
            scene = new THREE.Scene();
            
            // 相機設置
            camera = new THREE.PerspectiveCamera(
                75,
                window.innerWidth / window.innerHeight,
                0.1,
                1000
            );
            camera.position.z = 5;
            
            // 渲染器設置
            renderer = new THREE.WebGLRenderer({
                antialias: true,
                alpha: true,
                xr: { enabled: true }
            });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            renderer.outputEncoding = THREE.sRGBEncoding;
            
            const container = document.getElementById('scene-container');
            container.appendChild(renderer.domElement);
            
            // 添加光源
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(0, 1, 2);
            scene.add(directionalLight);
            
            // 添加網格輔助線（桌面模式）
            const gridHelper = new THREE.GridHelper(10, 10);
            gridHelper.visible = !isARActive;
            scene.add(gridHelper);
            
            // 窗口調整大小
            window.addEventListener('resize', onWindowResize);
            
            // 開始渲染循環
            animate();
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        // 載入視頻文件
        function loadVideos() {
            const fileInput = document.getElementById('file-input');
            const files = fileInput.files;
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const url = URL.createObjectURL(file);
                addVideo(url, file.name);
            }
            
            updateStatus(`載入了 ${files.length} 個視頻`);
        }
        
        // 添加視頻到場景
        function addVideo(url, name) {
            const video = document.createElement('video');
            video.src = url;
            video.loop = true;
            video.muted = true; // 自動播放需要靜音
            video.playsInline = true;
            video.crossOrigin = 'anonymous';
            
            // 創建視頻紋理
            const texture = new THREE.VideoTexture(video);
            texture.minFilter = THREE.LinearFilter;
            texture.magFilter = THREE.LinearFilter;
            texture.format = THREE.RGBAFormat;
            
            // 創建透明材質
            const material = new THREE.MeshBasicMaterial({
                map: texture,
                side: THREE.DoubleSide,
                transparent: true,
                alphaTest: 0.5
            });
            
            // 創建平面幾何體
            const aspectRatio = 16 / 9; // 預設寬高比
            const geometry = new THREE.PlaneGeometry(2 * aspectRatio, 2);
            const plane = new THREE.Mesh(geometry, material);
            
            // 設置初始位置
            const index = videos.length;
            plane.position.x = (index % 3 - 1) * 3;
            plane.position.y = Math.floor(index / 3) * 2;
            plane.position.z = 0;
            
            scene.add(plane);
            
            // 保存引用
            videos.push({
                element: video,
                texture: texture,
                plane: plane,
                name: name,
                id: `video-${Date.now()}-${index}`
            });
            
            // 創建控制界面
            createVideoControls(videos[videos.length - 1]);
            
            // 嘗試自動播放
            video.play().catch(e => {
                console.log('自動播放失敗，需要用戶交互');
            });
        }
        
        // 創建單個視頻的控制界面
        function createVideoControls(videoObj) {
            const controlsDiv = document.getElementById('video-controls');
            
            const videoControl = document.createElement('div');
            videoControl.className = 'video-control';
            videoControl.id = videoObj.id;
            
            videoControl.innerHTML = `
                <h3>${videoObj.name}</h3>
                
                <div class="control-group">
                    <button onclick="togglePlay('${videoObj.id}')">播放/暫停</button>
                    <button class="remove-btn" onclick="removeVideo('${videoObj.id}')">移除</button>
                </div>
                
                <div class="control-group">
                    <label>位置 X:</label>
                    <input type="range" min="-10" max="10" step="0.1" value="${videoObj.plane.position.x}" 
                           oninput="updatePosition('${videoObj.id}', 'x', this.value)">
                    <input type="number" min="-10" max="10" step="0.1" value="${videoObj.plane.position.x}"
                           oninput="updatePosition('${videoObj.id}', 'x', this.value)">
                </div>
                
                <div class="control-group">
                    <label>位置 Y:</label>
                    <input type="range" min="-10" max="10" step="0.1" value="${videoObj.plane.position.y}" 
                           oninput="updatePosition('${videoObj.id}', 'y', this.value)">
                    <input type="number" min="-10" max="10" step="0.1" value="${videoObj.plane.position.y}"
                           oninput="updatePosition('${videoObj.id}', 'y', this.value)">
                </div>
                
                <div class="control-group">
                    <label>位置 Z:</label>
                    <input type="range" min="-10" max="10" step="0.1" value="${videoObj.plane.position.z}" 
                           oninput="updatePosition('${videoObj.id}', 'z', this.value)">
                    <input type="number" min="-10" max="10" step="0.1" value="${videoObj.plane.position.z}"
                           oninput="updatePosition('${videoObj.id}', 'z', this.value)">
                </div>
                
                <div class="control-group">
                    <label>旋轉 Y:</label>
                    <input type="range" min="-180" max="180" step="1" value="0" 
                           oninput="updateRotation('${videoObj.id}', 'y', this.value)">
                    <input type="number" min="-180" max="180" step="1" value="0"
                           oninput="updateRotation('${videoObj.id}', 'y', this.value)">
                </div>
                
                <div class="control-group">
                    <label>縮放:</label>
                    <input type="range" min="0.1" max="5" step="0.1" value="1" 
                           oninput="updateScale('${videoObj.id}', this.value)">
                    <input type="number" min="0.1" max="5" step="0.1" value="1"
                           oninput="updateScale('${videoObj.id}', this.value)">
                </div>
                
                <div class="control-group">
                    <label>透明度:</label>
                    <input type="range" min="0" max="1" step="0.1" value="1" 
                           oninput="updateOpacity('${videoObj.id}', this.value)">
                    <input type="number" min="0" max="1" step="0.1" value="1"
                           oninput="updateOpacity('${videoObj.id}', this.value)">
                </div>
            `;
            
            controlsDiv.appendChild(videoControl);
        }
        
        // 控制函數
        function togglePlay(videoId) {
            const video = videos.find(v => v.id === videoId);
            if (video) {
                if (video.element.paused) {
                    video.element.play();
                } else {
                    video.element.pause();
                }
            }
        }
        
        function togglePlayAll() {
            const allPaused = videos.every(v => v.element.paused);
            videos.forEach(v => {
                if (allPaused) {
                    v.element.play();
                } else {
                    v.element.pause();
                }
            });
        }
        
        function updatePosition(videoId, axis, value) {
            const video = videos.find(v => v.id === videoId);
            if (video) {
                video.plane.position[axis] = parseFloat(value);
                // 同步更新所有相關的輸入框
                const controls = document.getElementById(videoId);
                const inputs = controls.querySelectorAll(`input[oninput*="'${axis}'"]`);
                inputs.forEach(input => input.value = value);
            }
        }
        
        function updateRotation(videoId, axis, value) {
            const video = videos.find(v => v.id === videoId);
            if (video) {
                video.plane.rotation[axis] = THREE.MathUtils.degToRad(parseFloat(value));
                // 同步更新輸入框
                const controls = document.getElementById(videoId);
                const inputs = controls.querySelectorAll(`input[oninput*="Rotation"]`);
                inputs.forEach(input => input.value = value);
            }
        }
        
        function updateScale(videoId, value) {
            const video = videos.find(v => v.id === videoId);
            if (video) {
                const scale = parseFloat(value);
                video.plane.scale.set(scale, scale, scale);
                // 同步更新輸入框
                const controls = document.getElementById(videoId);
                const inputs = controls.querySelectorAll(`input[oninput*="Scale"]`);
                inputs.forEach(input => input.value = value);
            }
        }
        
        function updateOpacity(videoId, value) {
            const video = videos.find(v => v.id === videoId);
            if (video) {
                video.plane.material.opacity = parseFloat(value);
                // 同步更新輸入框
                const controls = document.getElementById(videoId);
                const inputs = controls.querySelectorAll(`input[oninput*="Opacity"]`);
                inputs.forEach(input => input.value = value);
            }
        }
        
        function removeVideo(videoId) {
            const index = videos.findIndex(v => v.id === videoId);
            if (index !== -1) {
                const video = videos[index];
                scene.remove(video.plane);
                video.element.pause();
                video.element.src = '';
                video.texture.dispose();
                video.plane.geometry.dispose();
                video.plane.material.dispose();
                
                videos.splice(index, 1);
                
                // 移除控制界面
                const control = document.getElementById(videoId);
                control.remove();
                
                updateStatus(`移除視頻: ${video.name}`);
            }
        }
        
        function resetPositions() {
            videos.forEach((video, index) => {
                video.plane.position.x = (index % 3 - 1) * 3;
                video.plane.position.y = Math.floor(index / 3) * 2;
                video.plane.position.z = 0;
                video.plane.rotation.set(0, 0, 0);
                video.plane.scale.set(1, 1, 1);
                video.plane.material.opacity = 1;
                
                // 更新控制界面
                const controls = document.getElementById(video.id);
                if (controls) {
                    controls.querySelectorAll('input[type="range"], input[type="number"]').forEach(input => {
                        if (input.oninput.includes('position') && input.oninput.includes('x')) {
                            input.value = video.plane.position.x;
                        } else if (input.oninput.includes('position') && input.oninput.includes('y')) {
                            input.value = video.plane.position.y;
                        } else if (input.oninput.includes('position') && input.oninput.includes('z')) {
                            input.value = video.plane.position.z;
                        } else if (input.oninput.includes('Rotation')) {
                            input.value = 0;
                        } else if (input.oninput.includes('Scale')) {
                            input.value = 1;
                        } else if (input.oninput.includes('Opacity')) {
                            input.value = 1;
                        }
                    });
                }
            });
            
            updateStatus('所有視頻位置已重置');
        }
        
        // AR 功能
        async function toggleAR() {
            if (!navigator.xr) {
                updateStatus('此瀏覽器不支持 WebXR');
                return;
            }
            
            if (isARActive) {
                stopAR();
            } else {
                startAR();
            }
        }
        
        async function startAR() {
            try {
                // 檢查 AR 支持
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                if (!supported) {
                    updateStatus('此設備不支持 AR');
                    return;
                }
                
                // 請求 AR 會話
                xrSession = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['hit-test'],
                    optionalFeatures: ['dom-overlay'],
                    domOverlay: { root: document.body }
                });
                
                // 設置渲染器
                await renderer.xr.setSession(xrSession);
                renderer.xr.enabled = true;
                
                xrSession.addEventListener('end', onXRSessionEnd);
                
                // 獲取參考空間
                xrRefSpace = await xrSession.requestReferenceSpace('local');
                
                isARActive = true;
                document.getElementById('ar-button').textContent = '退出 AR';
                updateStatus('AR 模式已啟動');
                
                // 隱藏網格
                scene.traverse((child) => {
                    if (child instanceof THREE.GridHelper) {
                        child.visible = false;
                    }
                });
                
            } catch (error) {
                console.error('啟動 AR 失敗:', error);
                updateStatus('啟動 AR 失敗: ' + error.message);
            }
        }
        
        function stopAR() {
            if (xrSession) {
                xrSession.end();
            }
        }
        
        function onXRSessionEnd() {
            xrSession = null;
            isARActive = false;
            renderer.xr.enabled = false;
            document.getElementById('ar-button').textContent = '啟動 AR';
            updateStatus('已退出 AR 模式');
            
            // 顯示網格
            scene.traverse((child) => {
                if (child instanceof THREE.GridHelper) {
                    child.visible = true;
                }
            });
        }
        
        // 渲染循環
        function animate() {
            renderer.setAnimationLoop(render);
        }
        
        function render(timestamp, frame) {
            // 更新視頻紋理
            videos.forEach(video => {
                if (video.element.readyState >= video.element.HAVE_CURRENT_DATA) {
                    video.texture.needsUpdate = true;
                }
            });
            
            // 渲染場景
            renderer.render(scene, camera);
        }
        
        // 狀態更新
        function updateStatus(message) {
            document.getElementById('status').textContent = message;
            setTimeout(() => {
                document.getElementById('status').textContent = '準備就緒';
            }, 3000);
        }
        
        // 滑鼠控制（桌面模式）
        let mouseDown = false;
        let mouseX = 0;
        let mouseY = 0;
        
        document.addEventListener('mousedown', (e) => {
            if (e.target === renderer.domElement) {
                mouseDown = true;
                mouseX = e.clientX;
                mouseY = e.clientY;
            }
        });
        
        document.addEventListener('mouseup', () => {
            mouseDown = false;
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!mouseDown || isARActive) return;
            
            const deltaX = e.clientX - mouseX;
            const deltaY = e.clientY - mouseY;
            
            camera.rotation.y += deltaX * 0.01;
            camera.rotation.x += deltaY * 0.01;
            
            mouseX = e.clientX;
            mouseY = e.clientY;
        });
        
        // 滾輪縮放（桌面模式）
        document.addEventListener('wheel', (e) => {
            if (isARActive) return;
            camera.position.z += e.deltaY * 0.01;
            camera.position.z = Math.max(1, Math.min(20, camera.position.z));
        });
        
        // 初始化
        initScene();
        updateStatus('應用已初始化，請載入視頻文件');
    </script>
</body>
</html>