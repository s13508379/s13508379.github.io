<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR GLB Viewer</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #000;
            color: white;
            overflow: hidden;
        }
        
        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
        }
        
        #ui {
            position: absolute;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            max-width: 300px;
        }
        
        button {
            background: #007bff;
            border: none;
            color: white;
            padding: 12px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            width: 100%;
        }
        
        button:hover {
            background: #0056b3;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        #status {
            background: rgba(0, 100, 0, 0.8);
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 12px;
        }
        
        #error {
            background: rgba(100, 0, 0, 0.8);
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-size: 12px;
            display: none;
        }
        
        #fallback {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            display: none;
        }
        
        .ar-indicator {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 0, 0, 0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            display: none;
        }
        
        .ar-indicator.active {
            display: block;
            background: rgba(0, 255, 0, 0.8);
        }
        
        input[type="file"] {
            background: #333;
            color: white;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 5px;
            margin: 5px 0;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="ui">
            <h3>AR GLB Viewer</h3>
            <div id="status">Loading AR capabilities...</div>
            <div id="error"></div>
            
            <button id="createModel">Create Sample Model</button>
            <input type="file" id="fileInput" accept=".glb,.gltf" />
            <button id="loadFile" disabled>Load GLB File</button>
            <button id="startAR" disabled>Start AR Experience</button>
            <button id="placeModel" disabled>Place Model</button>
            <button id="playAnimation" disabled>Play Animation</button>
            
            <div style="font-size: 11px; margin-top: 10px; opacity: 0.7;">
                <p>• Create or load a GLB model</p>
                <p>• Start AR (requires HTTPS & compatible device)</p>
                <p>• Tap to place model in AR space</p>
                <p>• Control animations</p>
            </div>
        </div>
        
        <div class="ar-indicator" id="arIndicator">AR Session Active</div>
        
        <div id="fallback">
            <h3>AR Not Available</h3>
            <p>AR requires:</p>
            <ul style="text-align: left;">
                <li>HTTPS connection</li>
                <li>Compatible device (Android Chrome, iOS Safari)</li>
                <li>WebXR support</li>
            </ul>
            <p>Showing 3D preview instead...</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        let scene, camera, renderer, arSession;
        let currentModel = null;
        let mixer = null;
        let clock = new THREE.Clock();
        let isARActive = false;
        let reticle = null;
        let hitTestSource = null;
        let localReferenceSpace = null;
        
        const statusDiv = document.getElementById('status');
        const errorDiv = document.getElementById('error');
        const arIndicator = document.getElementById('arIndicator');
        const fallbackDiv = document.getElementById('fallback');

        async function init() {
            // Set up Three.js scene
            scene = new THREE.Scene();
            
            // Camera setup
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.set(0, 0, 3);
            
            // Renderer with XR support
            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.xr.enabled = true;
            renderer.shadowMap.enabled = true;
            renderer.shadowMap.type = THREE.PCFSoftShadowMap;
            document.getElementById('container').appendChild(renderer.domElement);
            
            // Lighting for AR
            const ambientLight = new THREE.AmbientLight(0x404040, 0.6);
            scene.add(ambientLight);
            
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(1, 1, 1);
            directionalLight.castShadow = true;
            scene.add(directionalLight);
            
            // Create reticle for AR placement
            createReticle();
            
            // Check AR support
            await checkARSupport();
            
            // Set up controls
            setupControls();
            
            // Start render loop
            renderer.setAnimationLoop(render);
        }

        async function checkARSupport() {
            if (!navigator.xr) {
                showError('WebXR not supported');
                showFallback();
                return;
            }
            
            try {
                const supported = await navigator.xr.isSessionSupported('immersive-ar');
                if (supported) {
                    updateStatus('AR Ready! Create or load a model to begin.');
                    document.getElementById('startAR').disabled = false;
                } else {
                    showError('AR not supported on this device');
                    showFallback();
                }
            } catch (error) {
                showError('AR check failed: ' + error.message);
                showFallback();
            }
        }

        function createReticle() {
            const geometry = new THREE.RingGeometry(0.02, 0.04, 32);
            const material = new THREE.MeshBasicMaterial({ 
                color: 0x00ff00,
                transparent: true,
                opacity: 0.8
            });
            reticle = new THREE.Mesh(geometry, material);
            reticle.matrixAutoUpdate = false;
            reticle.visible = false;
            scene.add(reticle);
        }

        function createSampleModel() {
            // Remove existing model
            if (currentModel) {
                scene.remove(currentModel);
            }
            
            // Create animated cube
            const geometry = new THREE.BoxGeometry(0.2, 0.2, 0.2);
            const material = new THREE.MeshLambertMaterial({ 
                color: 0x00ff88,
                transparent: true,
                opacity: 0.9
            });
            
            currentModel = new THREE.Mesh(geometry, material);
            currentModel.castShadow = true;
            currentModel.receiveShadow = true;
            
            // Create animation
            const times = [0, 1, 2, 3, 4];
            const rotationValues = [
                0, 0, 0,
                0, Math.PI/2, 0,
                0, Math.PI, 0,
                0, 3*Math.PI/2, 0,
                0, 2*Math.PI, 0
            ];
            
            const scaleValues = [
                1, 1, 1,
                1.5, 1.5, 1.5,
                1, 1, 1,
                0.5, 0.5, 0.5,
                1, 1, 1
            ];
            
            const rotationTrack = new THREE.VectorKeyframeTrack('.rotation', times, rotationValues);
            const scaleTrack = new THREE.VectorKeyframeTrack('.scale', times, scaleValues);
            
            const clip = new THREE.AnimationClip('SampleAnimation', 4, [rotationTrack, scaleTrack]);
            
            mixer = new THREE.AnimationMixer(currentModel);
            const action = mixer.clipAction(clip);
            action.setLoop(THREE.LoopRepeat);
            action.play();
            
            // Position model for preview
            if (!isARActive) {
                currentModel.position.set(0, 0, 0);
                scene.add(currentModel);
            }
            
            updateStatus('Sample model created! Start AR to place it.');
            document.getElementById('placeModel').disabled = false;
            document.getElementById('playAnimation').disabled = false;
        }

        async function loadGLBFile() {
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                showError('Please select a GLB file');
                return;
            }
            
            updateStatus('Loading GLB file...');
            
            try {
                // This is a simplified GLB loading demonstration
                // In production, you'd use GLTFLoader
                const arrayBuffer = await file.arrayBuffer();
                updateStatus('GLB file loaded (demo parsing)');
                
                // For demo purposes, create a sample model
                createSampleModel();
                updateStatus('GLB model ready for AR!');
                
            } catch (error) {
                showError('Error loading GLB: ' + error.message);
            }
        }

        async function startAR() {
            try {
                updateStatus('Starting AR session...');
                
                arSession = await navigator.xr.requestSession('immersive-ar', {
                    requiredFeatures: ['local', 'hit-test']
                });
                
                renderer.xr.setSession(arSession);
                
                arSession.addEventListener('end', onARSessionEnd);
                
                // Get reference space
                localReferenceSpace = await arSession.requestReferenceSpace('local');
                
                // Set up hit testing
                const viewerSpace = await arSession.requestReferenceSpace('viewer');
                hitTestSource = await arSession.requestHitTestSource({ space: viewerSpace });
                
                isARActive = true;
                arIndicator.classList.add('active');
                updateStatus('AR session active! Look around and tap to place model.');
                
                document.getElementById('startAR').disabled = true;
                document.getElementById('placeModel').disabled = currentModel ? false : true;
                
            } catch (error) {
                showError('AR session failed: ' + error.message);
            }
        }

        function onARSessionEnd() {
            isARActive = false;
            arIndicator.classList.remove('active');
            updateStatus('AR session ended');
            document.getElementById('startAR').disabled = false;
            document.getElementById('placeModel').disabled = true;
            
            if (hitTestSource) {
                hitTestSource.cancel();
                hitTestSource = null;
            }
        }

        function placeModel() {
            if (!currentModel || !isARActive) return;
            
            // Place model at reticle position
            if (reticle.visible) {
                currentModel.position.copy(reticle.position);
                currentModel.rotation.copy(reticle.rotation);
                
                if (!scene.children.includes(currentModel)) {
                    scene.add(currentModel);
                }
                
                updateStatus('Model placed in AR space!');
            } else {
                showError('No surface detected. Point camera at a flat surface.');
            }
        }

        function playAnimation() {
            if (mixer) {
                mixer.timeScale = mixer.timeScale === 1 ? 0 : 1;
                updateStatus(mixer.timeScale === 1 ? 'Animation playing' : 'Animation paused');
            }
        }

        function setupControls() {
            document.getElementById('createModel').addEventListener('click', createSampleModel);
            document.getElementById('loadFile').addEventListener('click', loadGLBFile);
            document.getElementById('startAR').addEventListener('click', startAR);
            document.getElementById('placeModel').addEventListener('click', placeModel);
            document.getElementById('playAnimation').addEventListener('click', playAnimation);
            
            document.getElementById('fileInput').addEventListener('change', () => {
                document.getElementById('loadFile').disabled = false;
            });
        }

        function render(timestamp, frame) {
            if (mixer) {
                mixer.update(clock.getDelta());
            }
            
            if (frame && hitTestSource) {
                // Hit test for AR placement
                const hitTestResults = frame.getHitTestResults(hitTestSource);
                
                if (hitTestResults.length > 0) {
                    const hit = hitTestResults[0];
                    const pose = hit.getPose(localReferenceSpace);
                    
                    reticle.visible = true;
                    reticle.matrix.fromArray(pose.transform.matrix);
                } else {
                    reticle.visible = false;
                }
            }
            
            renderer.render(scene, camera);
        }

        function updateStatus(message) {
            statusDiv.textContent = message;
            statusDiv.style.display = 'block';
            errorDiv.style.display = 'none';
        }

        function showError(message) {
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }

        function showFallback() {
            fallbackDiv.style.display = 'block';
            // Show 3D preview instead of AR
            if (currentModel) {
                scene.add(currentModel);
            }
        }

        // Handle window resize
        window.addEventListener('resize', () => {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(window.innerWidth, window.innerHeight);
        });

        // Initialize
        init();
    </script>
</body>
</html>