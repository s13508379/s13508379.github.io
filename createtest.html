<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AR Marker Creator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcode-generator/1.4.4/qrcode.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .controls {
            margin-bottom: 20px;
        }
        .control-group {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select, textarea {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box;
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background-color: #0056b3;
        }
        .preview {
            display: flex;
            gap: 20px;
            margin-top: 20px;
        }
        .marker-preview {
            border: 2px solid #333;
            background: white;
            padding: 20px;
            text-align: center;
            min-width: 300px;
            min-height: 300px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .qr-code {
            margin-bottom: 20px;
        }
        .marker-text {
            font-size: 48px;
            font-weight: bold;
            color: black;
            font-family: Arial, sans-serif;
        }
        .pattern-data {
            flex: 1;
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            overflow-y: auto;
            max-height: 400px;
        }
        canvas {
            border: 1px solid #ccc;
        }
        .download-section {
            margin-top: 20px;
            padding: 15px;
            background: #e9ecef;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AR Marker Creator</h1>
        
        <div class="controls">
            <div class="control-group">
                <label for="markerType">Marker Type:</label>
                <select id="markerType" onchange="updateMarkerType()">
                    <option value="qr">QR Code + Text</option>
                    <option value="simple">Simple AR-Friendly Pattern</option>
                </select>
            </div>
            
            <div class="control-group" id="qrControls">
                <label for="qrText">QR Code Content:</label>
                <input type="text" id="qrText" placeholder="Enter URL or text for QR code" value="https://example.com">
            </div>
            
            <div class="control-group" id="qrSizeControl">
                <label for="qrSize">QR Code Size:</label>
                <input type="range" id="qrSize" min="100" max="200" value="150">
                <span id="qrSizeValue">150px</span>
            </div>
            
            <div class="control-group">
                <label for="markerText">Marker Text:</label>
                <input type="text" id="markerText" placeholder="Enter text below QR code" value="Hiro">
            </div>
            
            <div class="control-group">
                <label for="fontSize">Font Size:</label>
                <input type="range" id="fontSize" min="20" max="80" value="48">
                <span id="fontSizeValue">48px</span>
            </div>
            
            <div class="control-group">
                <label for="qrSize">QR Code Size:</label>
                <input type="range" id="qrSize" min="100" max="200" value="150">
                <span id="qrSizeValue">150px</span>
            </div>
            
            <button onclick="generateMarker()">Generate Marker</button>
            <button onclick="downloadMarker()">Download Marker Image</button>
            <button onclick="downloadPattFile()">Download .patt File</button>
        </div>
        
        <div class="preview">
            <div class="marker-preview" id="markerPreview">
                <div class="qr-code" id="qrCode"></div>
                <div class="marker-text" id="textDisplay">Hiro</div>
            </div>
            <div class="pattern-data" id="patternData">
                <strong>Generated .patt data will appear here...</strong>
            </div>
        </div>
        
        <div class="download-section">
            <h3>How to use your AR marker:</h3>
            <ol>
                <li>Download the marker image and print it on white paper</li>
                <li>Download the .patt file and use it in your AR.js application</li>
                <li>Reference the .patt file in your AR code like: <code>marker-url="path/to/your/marker.patt"</code></li>
            </ol>
        </div>
    </div>

    <script>
        let currentMarkerData = null;

        function updateMarkerType() {
            const markerType = document.getElementById('markerType').value;
            const qrControls = document.getElementById('qrControls');
            const qrSizeControl = document.getElementById('qrSizeControl');
            
            if (markerType === 'qr') {
                qrControls.style.display = 'block';
                qrSizeControl.style.display = 'block';
            } else {
                qrControls.style.display = 'none';
                qrSizeControl.style.display = 'none';
            }
        }

        function generateMarker() {
            const markerType = document.getElementById('markerType').value;
            const markerText = document.getElementById('markerText').value;
            const fontSize = document.getElementById('fontSize').value;
            
            // Update font size display
            document.getElementById('fontSizeValue').textContent = fontSize + 'px';
            
            // Update text display
            const textDisplay = document.getElementById('textDisplay');
            textDisplay.textContent = markerText;
            textDisplay.style.fontSize = fontSize + 'px';
            
            const qrCodeDiv = document.getElementById('qrCode');
            qrCodeDiv.innerHTML = '';
            
            if (markerType === 'qr') {
                const qrText = document.getElementById('qrText').value;
                const qrSize = document.getElementById('qrSize').value;
                document.getElementById('qrSizeValue').textContent = qrSize + 'px';
                
                // Generate QR code
                const qr = qrcode(0, 'M');
                qr.addData(qrText);
                qr.make();
                
                // Create canvas and draw QR code
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const size = parseInt(qrSize);
                const moduleCount = qr.getModuleCount();
                const cellSize = size / moduleCount;
                
                canvas.width = size;
                canvas.height = size;
                
                // Fill white background
                ctx.fillStyle = '#ffffff';
                ctx.fillRect(0, 0, size, size);
                
                // Draw QR modules
                ctx.fillStyle = '#000000';
                for (let row = 0; row < moduleCount; row++) {
                    for (let col = 0; col < moduleCount; col++) {
                        if (qr.isDark(row, col)) {
                            ctx.fillRect(col * cellSize, row * cellSize, cellSize, cellSize);
                        }
                    }
                }
                
                qrCodeDiv.appendChild(canvas);
                generatePatternData(canvas, markerText, fontSize);
            } else {
                // Generate simple AR-friendly pattern
                generateSimplePattern(markerText, fontSize);
            }
        }

        function generateSimplePattern(text, fontSize) {
            // Create a simple, AR-friendly pattern
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 150;
            canvas.height = 150;
            
            // White background
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, 150, 150);
            
            // Black border
            ctx.fillStyle = '#000000';
            ctx.fillRect(0, 0, 150, 10);
            ctx.fillRect(0, 140, 150, 10);
            ctx.fillRect(0, 0, 10, 150);
            ctx.fillRect(140, 0, 10, 150);
            
            // Simple geometric pattern
            ctx.fillStyle = '#000000';
            ctx.fillRect(30, 30, 90, 20);
            ctx.fillRect(30, 60, 20, 60);
            ctx.fillRect(100, 60, 20, 60);
            ctx.fillRect(60, 100, 30, 20);
            
            document.getElementById('qrCode').appendChild(canvas);
            generatePatternData(canvas, text, fontSize);
        }

        function generatePatternData(qrCanvas, text, fontSize) {
            // Create a canvas to render the complete marker
            const markerCanvas = document.createElement('canvas');
            const ctx = markerCanvas.getContext('2d');
            
            markerCanvas.width = 400;
            markerCanvas.height = 400;
            
            // Fill with white background
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, 400, 400);
            
            // Draw QR code
            const qrSize = parseInt(document.getElementById('qrSize').value);
            const qrX = (400 - qrSize) / 2;
            const qrY = 50;
            ctx.drawImage(qrCanvas, qrX, qrY, qrSize, qrSize);
            
            // Draw text
            ctx.fillStyle = 'black';
            ctx.font = `bold ${fontSize}px Arial`;
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, 200, 300);
            
            // Convert to pattern data
            const patternData = canvasToPatternData(markerCanvas);
            currentMarkerData = {
                canvas: markerCanvas,
                patternData: patternData
            };
            
            // Display pattern data
            document.getElementById('patternData').innerHTML = 
                '<strong>Generated .patt data:</strong><br><br>' + 
                '<textarea readonly rows="15" style="width: 100%; font-family: monospace; font-size: 10px;">' + 
                patternData + '</textarea>';
        }

        function canvasToPatternData(canvas) {
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const data = imageData.data;
            
            // Scale down to 16x16 pattern
            const patternSize = 16;
            const scaleX = canvas.width / patternSize;
            const scaleY = canvas.height / patternSize;
            
            const patterns = [];
            
            // Generate 3 patterns (for different lighting conditions)
            for (let p = 0; p < 3; p++) {
                const pattern = [];
                
                for (let row = 0; row < patternSize; row++) {
                    for (let col = 0; col < patternSize; col++) {
                        // Sample pixel from scaled position
                        const x = Math.floor(col * scaleX);
                        const y = Math.floor(row * scaleY);
                        const index = (y * canvas.width + x) * 4;
                        
                        // Convert to grayscale and ensure values are in correct range
                        const r = data[index] || 255;
                        const g = data[index + 1] || 255;
                        const b = data[index + 2] || 255;
                        const gray = Math.round((r + g + b) / 3);
                        
                        // Clamp values between 0 and 255
                        const clampedGray = Math.max(0, Math.min(255, gray));
                        pattern.push(clampedGray);
                    }
                }
                patterns.push(pattern);
            }
            
            // Convert to proper .patt format
            let pattContent = '';
            
            // Each pattern should be on separate lines
            patterns.forEach((pattern, patternIndex) => {
                for (let row = 0; row < patternSize; row++) {
                    for (let col = 0; col < patternSize; col++) {
                        const index = row * patternSize + col;
                        if (col > 0) pattContent += ' ';
                        pattContent += pattern[index].toString().padStart(3, ' ');
                    }
                    pattContent += '\n';
                }
                // Add blank line between patterns except after the last one
                if (patternIndex < patterns.length - 1) {
                    pattContent += '\n';
                }
            });
            
            return pattContent;
        }

        function downloadMarker() {
            if (!currentMarkerData) {
                alert('Please generate a marker first');
                return;
            }
            
            const canvas = currentMarkerData.canvas;
            const link = document.createElement('a');
            link.download = 'ar_marker.png';
            link.href = canvas.toDataURL();
            link.click();
        }

        function downloadPattFile() {
            if (!currentMarkerData) {
                alert('Please generate a marker first');
                return;
            }
            
            const pattContent = currentMarkerData.patternData;
            const blob = new Blob([pattContent], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.download = 'marker.patt';
            link.href = url;
            link.click();
            
            URL.revokeObjectURL(url);
        }

        // Update sliders in real-time
        document.getElementById('fontSize').addEventListener('input', function() {
            document.getElementById('fontSizeValue').textContent = this.value + 'px';
        });

        document.getElementById('qrSize').addEventListener('input', function() {
            document.getElementById('qrSizeValue').textContent = this.value + 'px';
        });

        // Generate initial marker
        generateMarker();
    </script>
</body>
</html>